<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестирование</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --error: #ef4444;
            --border: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 40px; }

        /* Layout & Typography */
        header { background: var(--card-bg); padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        h1 { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        h2 { font-size: 1.5rem; margin-bottom: 1rem; }
        h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }
        .hidden { display: none !important; }
        
        /* Buttons */
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--bg); }
        .btn-icon { background: transparent; font-size: 1.2rem; cursor: pointer; border: none; }

        /* Card Styles */
        .card { background: var(--card-bg); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        
        /* Dashboard / Test List */
        .upload-zone { border: 2px dashed var(--border); padding: 2rem; text-align: center; border-radius: 0.5rem; cursor: pointer; margin-bottom: 2rem; }
        .upload-zone:hover { border-color: var(--primary); background: #eff6ff; }
        
        .test-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); }
        .test-item:last-child { border-bottom: none; }
        .test-actions { display: flex; gap: 0.5rem; }

        .test-title {
            display: -webkit-box;
            -webkit-line-clamp: 3; /* max lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word; /* wrap long words */
            margin-right: 1rem;
        }

        /* Settings */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        input[type="number"] { width: 80px; padding: 0.25rem; }

        /* Quiz Interface */
        .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 1.5rem; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        
        .question-text { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; line-height: 1.5; }
        
        .variants-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .variant-btn { text-align: left; padding: 1rem; border: 1px solid var(--border); background: var(--card-bg); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .variant-btn:hover { background: var(--bg); border-color: var(--primary); }
        
        .variant-btn.correct { background: #d1fae5; border-color: var(--success); color: #065f46; }
        .variant-btn.incorrect { background: #fee2e2; border-color: var(--error); color: #991b1b; }
        .variant-btn.disabled { pointer-events: none; opacity: 0.7; }

        .quiz-controls { margin-top: 1.5rem; display: flex; justify-content: space-between; }

        /* History */
        .history-item { font-size: 0.9rem; color: var(--text-light); margin-top: 0.25rem; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 200; }
        .modal { background: var(--card-bg); padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; display: flex; flex-direction: column; max-height: 85vh; }
        .chunk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 1rem; max-height: 300px; overflow-y: auto; }

        /* Error List Styles */
        .error-list { margin-top: 1rem; overflow-y: auto; flex: 1; border: 1px solid #fee2e2; border-radius: 0.375rem; }
        .error-item { padding: 0.75rem; border-bottom: 1px solid #fee2e2; background: #fef2f2; }
        .error-item:last-child { border-bottom: none; }
        .error-title { font-weight: bold; color: var(--error); font-size: 0.9rem; margin-bottom: 0.25rem; }
        .error-context { font-family: monospace; font-size: 0.85rem; color: var(--text); background: rgba(255,255,255,0.5); padding: 0.25rem; border-radius: 0.25rem; }

    </style>
</head>
<body>

    <header>
        <h1 onclick="app.navigate('home')" style="cursor: pointer;">Тесты</h1>
        <nav>
            <button class="btn btn-outline" onclick="app.navigate('settings')">Настройки</button>
            <button class="btn btn-primary" onclick="app.navigate('home')">Главная</button>
        </nav>
    </header>

    <div id="app" class="container">
        
        <section id="view-home">
            <div class="card upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>Нажмите для загрузки файла теста</h3>
                <p style="color: var(--text-light)">Формат: &lt;question&gt;...&lt;variant&gt;... (нужно 5 вариантов)</p>
                <input type="file" id="fileInput" multiple accept=".txt,.html,.xml" style="display: none" onchange="app.handleFileUpload(this)">
            </div>

            <div class="card">
                <h2>Мои Тесты</h2>
                <div id="test-list-container">
                    <p style="text-align: center; color: var(--text-light); padding: 1rem;">Тесты еще не загружены.</p>
                </div>
            </div>
        </section>

        <section id="view-settings" class="hidden">
            <div class="card">
                <h2>Глобальные настройки</h2>
                
                <div class="setting-row">
                    <label>Вопросов в блоке заучивания</label>
                    <input type="number" id="setting-cram-size" value="60" min="10">
                </div>
                
                <div class="setting-row">
                    <label>Вопросов в режиме теста</label>
                    <input type="number" id="setting-test-size" value="30" min="5">
                </div>
                
                <div class="setting-row">
                    <label>Перемешивать варианты</label>
                    <input type="checkbox" id="setting-shuffle-variants" checked>
                </div>
                
                <div class="setting-row">
                    <label>Показывать ответ сразу</label>
                    <input type="checkbox" id="setting-instant-feedback" checked>
                </div>

                <div style="margin-top: 1.5rem; text-align: right;">
                    <button class="btn btn-primary" onclick="app.saveSettings()">Сохранить</button>
                    <button class="btn btn-outline" onclick="app.clearData()">Стереть все данные</button>
                </div>
            </div>
        </section>

        <section id="view-quiz" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span id="quiz-mode-label" style="font-weight: bold; color: var(--primary);">Режим</span>
                    <span id="quiz-counter">1 / 30</span>
                </div>
                
                <div class="progress-bar">
                    <div id="quiz-progress" class="progress-fill"></div>
                </div>

                <div id="question-container">
                    <div id="question-text" class="question-text">Загрузка...</div>
                    <div id="variants-container" class="variants-list">
                        </div>
                </div>

                <div class="quiz-controls">
                    <button class="btn btn-outline" onclick="app.quitQuiz()">Выйти</button>
                    <button id="btn-next" class="btn btn-primary hidden" onclick="app.nextQuestion()">Следующий вопрос</button>
                </div>
            </div>
        </section>

        <section id="view-results" class="hidden">
            <div class="card" style="text-align: center; padding: 3rem;">
                <h2>Тест завершен!</h2>
                <h1 style="font-size: 3rem; color: var(--primary); margin: 1rem 0;" id="result-score">85%</h1>
                <p id="result-details" style="margin-bottom: 2rem;">Вы ответили верно на 25 из 30 вопросов.</p>
                <button class="btn btn-primary" onclick="app.navigate('home')">На главную</button>
            </div>
        </section>

    </div>

    <div id="modal-chunk" class="modal-overlay hidden">
        <div class="modal">
            <h3>Выберите блок для изучения</h3>
            <p>Тест большой. Выберите диапазон вопросов:</p>
            <div id="chunk-list" class="chunk-grid"></div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-outline" onclick="document.getElementById('modal-chunk').classList.add('hidden')">Отмена</button>
            </div>
        </div>
    </div>

    <div id="modal-error" class="modal-overlay hidden">
        <div class="modal" style="border-top: 4px solid var(--error);">
            <h3 style="color: var(--error)">Ошибка загрузки</h3>
            <p id="error-intro-text">В файле найдены ошибки:</p>
            <div id="error-list" class="error-list">
                </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-primary" onclick="document.getElementById('modal-error').classList.add('hidden')">Закрыть</button>
            </div>
        </div>
    </div>

<script>
/**
 * APP LOGIC
 */
const app = {
    // State
    data: {
        tests: [], // { id, name, questions: [] }
        history: [], // { testId, score, total, date, mode }
    },
    settings: {
        cramSize: 60,
        testSize: 30,
        shuffleVariants: true,
        instantFeedback: true
    },
    currentSession: {
        questions: [], // Active set of questions
        currentIndex: 0,
        score: 0,
        answers: [], // Track user answers
        mode: '', // 'cram' or 'test'
        testId: null
    },

    /**
     * Initialization
     */
    init: function() {
        this.loadFromStorage();
        this.renderTestList();
        this.populateSettings();
    },

    loadFromStorage: function() {
        const savedData = localStorage.getItem('studyflow_data');
        const savedSettings = localStorage.getItem('studyflow_settings');
        
        if (savedData) this.data = JSON.parse(savedData);
        if (savedSettings) this.settings = JSON.parse(savedSettings);
    },

    saveStorage: function() {
        localStorage.setItem('studyflow_data', JSON.stringify(this.data));
        localStorage.setItem('studyflow_settings', JSON.stringify(this.settings));
    },

    clearData: function() {
        if(confirm("Вы уверены? Это удалит все тесты и историю.")) {
            localStorage.removeItem('studyflow_data');
            location.reload();
        }
    },

    /**
     * File Parsing & Upload
     */
    handleFileUpload: function(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;

        let processedCount = 0;
        let hasErrors = false;

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const result = this.parseFileContent(content);
                
                if (!result.success) {
                    // Show Error Modal
                    hasErrors = true;
                    this.showErrors(file.name, result.errors);
                } else if (result.data.length > 0) {
                    const newTest = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        name: file.name.replace(/\.[^/.]+$/, ""), // Remove extension
                        questions: result.data,
                        dateAdded: Date.now()
                    };
                    this.data.tests.push(newTest);
                    this.saveStorage();
                    this.renderTestList();
                }

                processedCount++;
            };
            reader.readAsText(file);
        });
        
        input.value = ''; // Reset input
    },

    parseFileContent: function(text) {
        const rawBlocks = text.split(/<question>/i);
        const parsedQuestions = [];
        const errors = [];

        rawBlocks.forEach((block, index) => {
            if (!block.trim()) return;

            // We assume format: Text... <variant> Text... <variant> Text...
            const variantSplit = block.split(/<variant>/i);
            const questionText = variantSplit[0].trim();
            const variantsRaw = variantSplit.slice(1);

            // VALIDATION 1: Empty Question
            if (!questionText) {
                errors.push({
                    msg: "Текст вопроса отсутствует",
                    context: "Блок #" + index
                });
                return;
            }

            // VALIDATION 2: STRICT 5 VARIANTS
            if (variantsRaw.length !== 5) {
                // Create a snippet of the question for context (max 60 chars)
                const snippet = questionText.length > 60 ? questionText.substring(0, 60) + "..." : questionText;
                errors.push({
                    msg: `Найдено ${variantsRaw.length} вариантов. Строго требуется 5.`,
                    context: snippet
                });
                return;
            }

            // VALIDATION 3: Empty Variants check (optional but recommended)
            const variants = variantsRaw.map((v, vIndex) => {
                return {
                    text: v.trim(),
                    isCorrect: vIndex === 0 // Requirement: First variant is always correct
                };
            });

            if (variants.some(v => v.text === "")) {
                const snippet = questionText.length > 60 ? questionText.substring(0, 60) + "..." : questionText;
                errors.push({
                    msg: "Один или несколько вариантов пустые.",
                    context: snippet
                });
                return;
            }

            parsedQuestions.push({
                q: questionText,
                v: variants
            });
        });

        if (errors.length > 0) {
            return { success: false, errors: errors };
        }

        return { success: true, data: parsedQuestions };
    },

    showErrors: function(fileName, errors) {
        const modal = document.getElementById('modal-error');
        const list = document.getElementById('error-list');
        const intro = document.getElementById('error-intro-text');
        
        intro.innerText = `Файл "${fileName}" содержит ${errors.length} ошибок. Импорт отменен.`;
        list.innerHTML = '';

        errors.forEach(err => {
            const item = document.createElement('div');
            item.className = 'error-item';
            item.innerHTML = `
                <div class="error-title">${err.msg}</div>
                <div class="error-context">${err.context.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
            `;
            list.appendChild(item);
        });

        modal.classList.remove('hidden');
    },

    /**
     * UI Rendering
     */
    renderTestList: function() {
        const container = document.getElementById('test-list-container');
        container.innerHTML = '';

        if (this.data.tests.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 1rem;">Тесты еще не загружены.</p>';
            return;
        }

        this.data.tests.forEach(test => {
            const history = this.data.history.filter(h => h.testId === test.id);
            const lastAttempt = history.length ? history[history.length - 1] : null;
            
            const div = document.createElement('div');
            div.className = 'test-item';
            div.innerHTML = `
                <div>
                    <h3 class="test-title">${test.name}</h3>
                    <div style="font-size: 0.9rem; color: var(--text-light)">
                        Вопросов: ${test.questions.length} 
                        ${lastAttempt ? `| Последний рез-т: ${Math.round((lastAttempt.score/lastAttempt.total)*100)}%` : ''}
                    </div>
                </div>
                <div class="test-actions">
                    <button class="btn btn-outline" onclick="app.prepCram('${test.id}')">Учить</button>
                    <button class="btn btn-primary" onclick="app.prepTest('${test.id}')">Тест</button>
                    <button class="btn btn-icon" style="color:var(--error)" onclick="app.deleteTest('${test.id}')">&times;</button>
                </div>
            `;
            container.appendChild(div);
        });
    },

    deleteTest: function(id) {
        if(confirm("Удалить этот тест?")) {
            this.data.tests = this.data.tests.filter(t => t.id !== id);
            this.data.history = this.data.history.filter(h => h.testId !== id);
            this.saveStorage();
            this.renderTestList();
        }
    },

    /**
     * Settings Logic
     */
    populateSettings: function() {
        document.getElementById('setting-cram-size').value = this.settings.cramSize;
        document.getElementById('setting-test-size').value = this.settings.testSize;
        document.getElementById('setting-shuffle-variants').checked = this.settings.shuffleVariants;
        document.getElementById('setting-instant-feedback').checked = this.settings.instantFeedback;
    },

    saveSettings: function() {
        this.settings.cramSize = parseInt(document.getElementById('setting-cram-size').value);
        this.settings.testSize = parseInt(document.getElementById('setting-test-size').value);
        this.settings.shuffleVariants = document.getElementById('setting-shuffle-variants').checked;
        this.settings.instantFeedback = document.getElementById('setting-instant-feedback').checked;
        
        this.saveStorage();
        this.navigate('home');
    },

    /**
     * Quiz Preparation Logic
     */
    prepCram: function(testId) {
        const test = this.data.tests.find(t => t.id === testId);
        if (!test) return;

        const totalQ = test.questions.length;
        const chunkSize = this.settings.cramSize;
        const chunks = Math.ceil(totalQ / chunkSize);

        if (chunks <= 1) {
            // Only one chunk, start immediately, BUT SHUFFLE FIRST
            let questions = JSON.parse(JSON.stringify(test.questions));
            this.shuffleArray(questions);
            this.startSession(testId, questions, 'cram');
            return;
        }

        // Show Modal for chunks
        const list = document.getElementById('chunk-list');
        list.innerHTML = '';
        for (let i = 0; i < chunks; i++) {
            const start = i * chunkSize;
            const end = Math.min((i + 1) * chunkSize, totalQ);
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline';
            btn.innerText = `В. ${start + 1} - ${end}`;
            btn.onclick = () => {
                let subset = test.questions.slice(start, end);
                // SHUFFLE THE CHUNK
                this.shuffleArray(subset); 
                document.getElementById('modal-chunk').classList.add('hidden');
                this.startSession(testId, subset, 'cram');
            };
            list.appendChild(btn);
        }
        document.getElementById('modal-chunk').classList.remove('hidden');
    },

    prepTest: function(testId) {
        const test = this.data.tests.find(t => t.id === testId);
        if (!test) return;

        // Shuffle all questions, then take top N
        let pool = [...test.questions];
        this.shuffleArray(pool);
        const subset = pool.slice(0, Math.min(this.settings.testSize, pool.length));

        this.startSession(testId, subset, 'test');
    },

    startSession: function(testId, questions, mode) {
        this.currentSession = {
            testId: testId,
            questions: JSON.parse(JSON.stringify(questions)), // Deep copy
            currentIndex: 0,
            score: 0,
            answers: new Array(questions.length).fill(null),
            mode: mode
        };

        this.navigate('quiz');
        this.renderQuestion();
    },

    /**
     * Quiz Execution Logic
     */
    renderQuestion: function() {
        const session = this.currentSession;
        const qData = session.questions[session.currentIndex];
        
        // Update Header
        document.getElementById('quiz-mode-label').innerText = session.mode === 'cram' ? 'Заучивание' : 'Тест';
        document.getElementById('quiz-counter').innerText = `${session.currentIndex + 1} / ${session.questions.length}`;
        document.getElementById('quiz-progress').style.width = `${((session.currentIndex) / session.questions.length) * 100}%`;

        // Render Question Text
        document.getElementById('question-text').innerText = qData.q;

        // Render Variants
        const vContainer = document.getElementById('variants-container');
        vContainer.innerHTML = '';

        // Clone variants to shuffle if needed
        let variants = [...qData.v];
        if (this.settings.shuffleVariants) {
            this.shuffleArray(variants);
        }

        variants.forEach((v, idx) => {
            const btn = document.createElement('button');
            btn.className = 'variant-btn';
            btn.innerText = v.text;
            // Store isCorrect in data attribute to check later
            btn.dataset.isCorrect = v.isCorrect;
            btn.onclick = (e) => this.handleAnswer(e.target, v.isCorrect);
            vContainer.appendChild(btn);
        });

        document.getElementById('btn-next').classList.add('hidden');
    },

    handleAnswer: function(btnElement, isCorrect) {
        const session = this.currentSession;
        
        // Prevent multiple answers if already answered
        if (session.answers[session.currentIndex] !== null) return;

        session.answers[session.currentIndex] = isCorrect;
        if (isCorrect) session.score++;

        // Cram Mode: Re-insert incorrect questions
        if (!isCorrect && session.mode === 'cram') {
            const currentQ = session.questions[session.currentIndex];
            
            const remainingQuestions = session.questions.length - (session.currentIndex + 1);
            let insertIndex;

            if (remainingQuestions <= 0) {
                insertIndex = session.questions.length;
            } else {
                const minOffset = 2; 
                const maxOffset = remainingQuestions;
                const safeMin = Math.min(minOffset, maxOffset);
                const randomOffset = Math.floor(Math.random() * (maxOffset - safeMin + 1)) + safeMin;
                insertIndex = session.currentIndex + 1 + randomOffset;
            }

            session.questions.splice(insertIndex, 0, currentQ);
            session.answers.splice(insertIndex, 0, null);
            document.getElementById('quiz-counter').innerText = `${session.currentIndex + 1} / ${session.questions.length}`;
        }

        const buttons = document.querySelectorAll('.variant-btn');

        if (this.settings.instantFeedback) {
            // Visual Feedback
            if (isCorrect) {
                btnElement.classList.add('correct');
            } else {
                btnElement.classList.add('incorrect');
                // Highlight the correct one
                buttons.forEach(b => {
                    if (b.dataset.isCorrect === "true") b.classList.add('correct');
                });
            }
            
            // Disable all buttons
            buttons.forEach(b => b.classList.add('disabled'));
            
            // Show Next Button
            document.getElementById('btn-next').classList.remove('hidden');
        } else {
            // Test Mode (Delayed Feedback) style
            btnElement.style.borderColor = "var(--primary)";
            btnElement.style.borderWidth = "2px";
            buttons.forEach(b => b.classList.add('disabled'));
            document.getElementById('btn-next').classList.remove('hidden');
        }
    },

    nextQuestion: function() {
        if (this.currentSession.currentIndex < this.currentSession.questions.length - 1) {
            this.currentSession.currentIndex++;
            this.renderQuestion();
        } else {
            this.finishQuiz();
        }
    },

    finishQuiz: function() {
        const session = this.currentSession;
        const percentage = Math.round((session.score / session.questions.length) * 100);
        
        // Save History
        this.data.history.push({
            testId: session.testId,
            score: session.score,
            total: session.questions.length,
            date: Date.now(),
            mode: session.mode
        });
        this.saveStorage();

        // Render Results
        document.getElementById('result-score').innerText = `${percentage}%`;
        document.getElementById('result-details').innerText = `Верно: ${session.score} из ${session.questions.length}.`;
        
        this.navigate('results');
    },

    quitQuiz: function() {
        if(confirm("Выйти? Прогресс будет потерян.")) {
            this.navigate('home');
        }
    },

    /**
     * Utilities
     */
    navigate: function(viewName) {
        ['home', 'settings', 'quiz', 'results'].forEach(v => {
            const el = document.getElementById(`view-${v}`);
            if (v === viewName) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });
        
        if (viewName === 'home') this.renderTestList();
    },

    shuffleArray: function(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
};

// Start the App
window.addEventListener('DOMContentLoaded', () => {
    app.init();
});

</script>
</body>
</html>